#!/bin/bash

set -e

echo "========================================"
echo "Running pre-push validation..."
echo "========================================"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILED=0

# Determine number of steps based on E2E flag
if [ "$SKIP_E2E" = "1" ]; then
  TOTAL_STEPS=3
else
  TOTAL_STEPS=4
fi

# Step 1: Unit tests
echo -e "${YELLOW}[1/${TOTAL_STEPS}] Running unit tests...${NC}"
if npm run test:unit 2>&1; then
  echo -e "${GREEN}Unit tests passed${NC}"
else
  echo -e "${RED}Unit tests FAILED${NC}"
  FAILED=1
fi

echo ""

# Step 2: Check baseline documentation
echo -e "${YELLOW}[2/${TOTAL_STEPS}] Reviewing baseline changes...${NC}"
if npm run baseline:review 2>&1; then
  echo -e "${GREEN}Baseline review passed${NC}"
else
  echo -e "${RED}Baseline changes lack documentation${NC}"
  FAILED=1
fi

echo ""

# Step 3: Build check
echo -e "${YELLOW}[3/${TOTAL_STEPS}] Verifying build...${NC}"
if npm run build 2>&1; then
  echo -e "${GREEN}Build succeeded${NC}"
else
  echo -e "${RED}Build FAILED${NC}"
  FAILED=1
fi

echo ""

# Step 4: E2E tests (CI-safe only, unless skipped)
if [ "$SKIP_E2E" = "1" ]; then
  echo -e "${YELLOW}[Skipped] E2E tests skipped (SKIP_E2E=1)${NC}"
else
  echo -e "${YELLOW}[4/${TOTAL_STEPS}] Running E2E tests (CI-safe)...${NC}"
  if npm run test:e2e 2>&1; then
    echo -e "${GREEN}E2E tests passed${NC}"
  else
    echo -e "${RED}E2E tests FAILED${NC}"
    FAILED=1
  fi
fi

echo ""
echo "========================================"

if [ $FAILED -eq 1 ]; then
  echo -e "${RED}Pre-push validation FAILED${NC}"
  echo "Push blocked. Fix the issues above and try again."
  echo ""
  echo "To skip E2E tests: SKIP_E2E=1 git push"
  echo "To skip all checks (NOT recommended): git push --no-verify"
  exit 1
fi

echo -e "${GREEN}All checks passed. Proceeding with push.${NC}"
exit 0
