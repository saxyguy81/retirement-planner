#!/bin/bash

set -e

echo "========================================"
echo "Running pre-push validation..."
echo "========================================"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILED=0

# Step 1: Unit tests
echo -e "${YELLOW}[1/3] Running unit tests...${NC}"
if npm run test:unit 2>&1; then
  echo -e "${GREEN}Unit tests passed${NC}"
else
  echo -e "${RED}Unit tests FAILED${NC}"
  FAILED=1
fi

echo ""

# Step 2: Check baseline documentation
echo -e "${YELLOW}[2/3] Reviewing baseline changes...${NC}"
if npm run baseline:review 2>&1; then
  echo -e "${GREEN}Baseline review passed${NC}"
else
  echo -e "${RED}Baseline changes lack documentation${NC}"
  FAILED=1
fi

echo ""

# Step 3: Build check
echo -e "${YELLOW}[3/3] Verifying build...${NC}"
if npm run build 2>&1; then
  echo -e "${GREEN}Build succeeded${NC}"
else
  echo -e "${RED}Build FAILED${NC}"
  FAILED=1
fi

echo ""
echo "========================================"

if [ $FAILED -eq 1 ]; then
  echo -e "${RED}Pre-push validation FAILED${NC}"
  echo "Push blocked. Fix the issues above and try again."
  echo ""
  echo "To skip (NOT recommended): git push --no-verify"
  exit 1
fi

echo -e "${GREEN}All checks passed. Proceeding with push.${NC}"
exit 0
